# =============================================================================
# Docker Compose - Production Environment
# =============================================================================
#
# USAGE:
#   cp .env.prod.example .env.prod
#   docker compose -f docker-compose.prod.yml up -d --build
#   docker compose -f docker-compose.prod.yml logs -f
#   docker compose -f docker-compose.prod.yml down  # Without volumes
#
# ACCESS (via Nginx):
#   Frontend: http://your-domain.com or http://your-vps-ip
#   Backend:  http://your-domain.com/api
#   API Docs: http://your-domain.com/docs
#
# IMPORTANT:
#   - Change DOMAIN_NAME to your actual domain or VPS IP
#   - Set proper JWT_SECRET in .env.prod
#   - Update database password for production
#   - Run: docker compose -f docker-compose.prod.yml exec api npx prisma migrate deploy
#
# =============================================================================

services:
  # =============================================================================
  # PostgreSQL Database
  # =============================================================================
  db:
    image: postgres:15-alpine
    container_name: erp-db-prod
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-tran_go_hoang_gia_erp}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # No port exposure - only internal network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =============================================================================
  # API Backend - NestJS (Internal only)
  # =============================================================================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: erp-api-prod
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-tran_go_hoang_gia_erp}?schema=public
      JWT_SECRET: ${JWT_SECRET:-change-this-secret-in-production}
      JWT_EXPIRES_IN: 7d
      # CORS: Only allow frontend domain via Nginx
      WEB_CORS_ORIGINS: ${FRONTEND_URL:-http://localhost}
    # No port exposure - only via Nginx
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - api_uploads:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Web Frontend - Next.js (Internal only)
  # =============================================================================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: erp-web-prod
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      # Use proxy mode - FE calls /api (goes through Nginx)
      NEXT_PUBLIC_API_URL: /
      NEXT_PUBLIC_USE_PROXY: "true"
      NEXT_PUBLIC_API_TIMEOUT: 15000
      NEXT_PUBLIC_ENABLE_LOGGING: "false"  # Disable logging in production
    # No port exposure - only via Nginx
    depends_on:
      - api

  # =============================================================================
  # Nginx Reverse Proxy (Public Entry Point)
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: erp-nginx-prod
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/certbot:/etc/letsencrypt:ro  # For SSL certificates
    depends_on:
      - api
      - web
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # Certbot (SSL Certificates - Optional)
  # =============================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: erp-certbot
    volumes:
      - ./data/certbot:/etc/letsencrypt:rw
      - ./data/www:/var/www/certbot:rw
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait; done'"
    depends_on:
      - nginx

# =============================================================================
# Volumes (Persistent Data)
# =============================================================================
volumes:
  postgres_data:
  api_uploads:

# =============================================================================
# Networks (Internal Only)
# =============================================================================
networks:
  default:
    name: erp-network-prod

