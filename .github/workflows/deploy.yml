name: Deploy to Server

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 2

            - name: Detect schema changes
              id: schema_check
              run: |
                  if git diff --name-only HEAD~1 HEAD | grep -q "apps/api/prisma/schema.prisma"; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Phat hien thay doi schema DB"
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "Khong co thay doi schema DB"
                  fi

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20.9.0"

            - name: Install dependencies
              run: npm ci

            - name: Run generate prisma client
              run: cd apps/api && npm run prisma:generate

            - name: Build the project
              run: npm run build

            - name: Deploy to server
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.SERVER_HOST }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.SERVER_KEY }}
                  port: ${{ secrets.SERVER_PORT }}
                  script: |
                      export PATH=$PATH:/root/.nvm/versions/node/v20.9.0/bin

                      which npm
                      which pm2

                      cd /var/www/projects/ERP-Trango/

                      git pull origin main
                      npm install

                      cd /var/www/projects/ERP-Trango/apps/api

                      if [ "${{ steps.schema_check.outputs.changed }}" = "true" ]; then
                        echo "Dang chay prisma migrate deploy..."
                        npx prisma migrate deploy
                        echo "Migration hoan tat"
                      else
                        echo "Bo qua migration (khong co thay doi schema)"
                      fi

                      npm run prisma:generate

                      cd /var/www/projects/ERP-Trango
                      npm run build
                      pm2 restart api-erp.trangohoanggia.com
                      pm2 restart erp.trangohoanggia.com
