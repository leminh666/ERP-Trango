generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  name                String
  phone               String?
  age                 Int?
  address             String?
  avatarUrl           String?
  note                String?
  role                UserRole             @default(STAFF)
  permissions         Json?
  isActive            Boolean              @default(true)
  deletedAt           DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  auditLogs           AuditLog[]
  crmActivities       CrmActivity[]
  crmCustomers        CrmCustomer[]        @relation("CrmCustomerOwner")
  crmStageHistories   CrmStageHistory[]
  customers           Customer[]           @relation("CustomerOwner")
  customerFollowUps   CustomerFollowUp[]
  passwordResetTokens PasswordResetToken[]

  @@index([deletedAt])
  @@index([role])
}

model CrmCustomer {
  id               String            @id @default(uuid())
  customerId       String            @unique
  legacyCustomerId String?           @unique
  stage            CrmStage          @default(LEAD)
  area             String?
  layout           String?
  style            String?
  architectureType String?
  briefNote        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  ownerUserId      String?
  activities       CrmActivity[]
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  ownerUser        User?             @relation("CrmCustomerOwner", fields: [ownerUserId], references: [id])
  stageHistories   CrmStageHistory[]

  @@index([stage])
  @@index([customerId])
  @@index([ownerUserId])
  @@index([legacyCustomerId])
}

model CrmActivity {
  id               String          @id @default(uuid())
  customerId       String
  userId           String
  type             CrmActivityType
  outcome          String?
  note             String?
  createdAt        DateTime        @default(now())
  nextFollowUpAt   DateTime?
  nextFollowUpNote String?
  followUpStatus   FollowUpStatus  @default(PENDING)
  priority         Priority        @default(MEDIUM)
  customer         CrmCustomer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user             User            @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([nextFollowUpAt])
  @@index([followUpStatus])
}

model CrmStageHistory {
  id         String      @id @default(uuid())
  customerId String
  userId     String
  fromStage  CrmStage?
  toStage    CrmStage
  note       String?     @default("")
  createdAt  DateTime    @default(now())
  customer   CrmCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id])

  @@index([customerId])
  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id          String   @id @default(uuid())
  entity      String
  entityId    String
  action      String
  beforeJson  Json?
  afterJson   Json?
  byUserId    String
  byUserEmail String?
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())
  byUser      User     @relation(fields: [byUserId], references: [id], onDelete: Cascade)

  @@index([entity, createdAt])
  @@index([byUserId, createdAt])
  @@index([entityId])
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  valueJson   String
  description String?
  createdAt   DateTime @updatedAt
  updatedAt   DateTime @updatedAt
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
}

model Customer {
  id               String             @id @default(uuid())
  code             String             @unique
  name             String
  phone            String?
  address          String?
  region           String?
  provinceCode     String?
  provinceName     String?
  districtCode     String?
  districtName     String?
  wardCode         String?
  wardName         String?
  addressLine      String?
  status           CustomerStatus     @default(NEW)
  lostReason       String?
  nextFollowUpAt   DateTime?
  nextFollowUpNote String?
  ownerUserId      String?
  tags             String?
  note             String?
  isActive         Boolean            @default(true)
  isSample         Boolean            @default(false)
  deletedAt        DateTime?
  sourceChannel    SourceChannel?
  sourceDetail     String?
  visualType       VisualType         @default(ICON)
  iconKey          String?
  imageUrl         String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  crm              CrmCustomer?
  owner            User?              @relation("CustomerOwner", fields: [ownerUserId], references: [id])
  followUps        CustomerFollowUp[]
  projects         Project[]

  @@index([status])
  @@index([region])
  @@index([sourceChannel])
  @@index([ownerUserId])
  @@index([nextFollowUpAt])
  @@index([deletedAt])
}

model CustomerFollowUp {
  id              String          @id @default(uuid())
  customerId      String
  type            FollowUpType
  scheduledAt     DateTime
  outcome         FollowUpOutcome @default(PENDING)
  outcomeNote     String?
  createdByUserId String?
  isSample        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdBy       User?           @relation(fields: [createdByUserId], references: [id])
  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([scheduledAt])
  @@index([outcome])
}

model Supplier {
  id           String     @id @default(uuid())
  code         String     @unique
  name         String
  phone        String?
  address      String?
  region       String?
  provinceCode String?
  provinceName String?
  districtCode String?
  districtName String?
  wardCode     String?
  wardName     String?
  addressLine  String?
  note         String?
  isActive     Boolean    @default(true)
  isSample     Boolean    @default(false)
  deletedAt    DateTime?
  visualType   VisualType @default(ICON)
  iconKey      String?
  imageUrl     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([deletedAt])
}

model Workshop {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  phone        String?
  address      String?
  provinceCode String?
  provinceName String?
  districtCode String?
  districtName String?
  wardCode     String?
  wardName     String?
  addressLine  String?
  note         String?
  isActive     Boolean       @default(true)
  isSample     Boolean       @default(false)
  deletedAt    DateTime?
  visualType   VisualType    @default(ICON)
  iconKey      String?
  imageUrl     String?
  color        String?       @default("#f97316")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  projects     Project[]
  workshopJobs WorkshopJob[]

  @@index([deletedAt])
}

model CodeSequence {
  key       String   @id
  value     Int      @default(1)
  updatedAt DateTime @updatedAt

  @@map("code_sequences")
}

model WorkshopJob {
  id              String            @id @default(uuid())
  code            String            @unique
  projectId       String
  workshopId      String
  title           String?
  description     String?
  amount          Decimal           @db.Decimal(15, 2)
  discountAmount  Decimal           @default(0) @db.Decimal(15, 2)
  paidAmount      Decimal           @default(0) @db.Decimal(15, 2)
  status          WorkshopJobStatus @default(DRAFT)
  startDate       DateTime?
  dueDate         DateTime?
  note            String?
  createdByUserId String?
  updatedByUserId String?
  deletedAt       DateTime?
  isSample        Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  payments        Transaction[]
  project         Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  workshop        Workshop          @relation(fields: [workshopId], references: [id])
  items           WorkshopJobItem[]

  @@index([projectId])
  @@index([workshopId])
  @@index([status])
  @@index([deletedAt])
}

model WorkshopJobItem {
  id            String      @id @default(uuid())
  workshopJobId String
  productId     String?
  productName   String
  unit          String
  quantity      Decimal     @db.Decimal(15, 2)
  unitPrice     Decimal     @db.Decimal(15, 2)
  lineTotal     Decimal     @db.Decimal(15, 2)
  isSample      Boolean     @default(false)
  createdAt     DateTime    @default(now())
  product       Product?    @relation(fields: [productId], references: [id])
  workshopJob   WorkshopJob @relation(fields: [workshopJobId], references: [id], onDelete: Cascade)

  @@index([workshopJobId])
  @@index([productId])
}

model IncomeCategory {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  iconKey      String?
  color        String?
  isActive     Boolean       @default(true)
  deletedAt    DateTime?
  visualType   VisualType    @default(ICON)
  imageUrl     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]

  @@index([deletedAt])
}

model ExpenseCategory {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  iconKey      String?
  color        String?
  isActive     Boolean       @default(true)
  deletedAt    DateTime?
  visualType   VisualType    @default(ICON)
  imageUrl     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]

  @@index([deletedAt])
}

model Product {
  id               String                  @id @default(uuid())
  code             String                  @unique
  name             String
  unit             String
  defaultSalePrice Decimal?                @db.Decimal(15, 2)
  productType      ProductType             @default(OTHER_ITEM)
  isActive         Boolean                 @default(true)
  deletedAt        DateTime?
  visualType       VisualType              @default(IMAGE)
  imageUrl         String                  @default("/placeholder-product.png")
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  orderItems       OrderItem[]
  attributeGroups  ProductAttributeGroup[]
  variants         ProductVariant[]
  workshopJobItems WorkshopJobItem[]

  @@index([deletedAt])
  @@index([productType])
}

model ProductAttributeGroup {
  id        String                  @id @default(uuid())
  name      String
  sortOrder Int                     @default(0)
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  productId String
  product   Product                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  values    ProductAttributeValue[]

  @@index([productId])
}

model ProductAttributeValue {
  id                String                    @id @default(uuid())
  value             String
  sortOrder         Int                       @default(0)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  groupId           String
  parentValueId     String?
  group             ProductAttributeGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  parentValue       ProductAttributeValue?    @relation("AttributeValueHierarchy", fields: [parentValueId], references: [id])
  childValues       ProductAttributeValue[]   @relation("AttributeValueHierarchy")
  variantAttributes ProductVariantAttribute[]

  @@index([groupId])
  @@index([parentValueId])
}

model ProductVariant {
  id         String                    @id @default(uuid())
  code       String?
  name       String
  price      Decimal?                  @db.Decimal(15, 2)
  imageUrl   String?
  isActive   Boolean                   @default(true)
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt
  productId  String
  orderItems OrderItem[]
  product    Product                   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributes ProductVariantAttribute[]

  @@index([productId])
  @@index([isActive])
}

model ProductVariantAttribute {
  id        String                @id @default(uuid())
  variantId String
  valueId   String
  value     ProductAttributeValue @relation(fields: [valueId], references: [id], onDelete: Cascade)
  variant   ProductVariant        @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([variantId, valueId])
  @@index([valueId])
}

model Wallet {
  id             String             @id @default(uuid())
  code           String             @unique
  name           String
  type           WalletType         @default(CASH)
  note           String?
  isActive       Boolean            @default(true)
  deletedAt      DateTime?
  visualType     VisualType         @default(ICON)
  iconKey        String?
  imageUrl       String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  transactions   Transaction[]
  transactionsTo Transaction[]      @relation("WalletToRelation")
  adjustments    WalletAdjustment[]

  @@index([deletedAt])
  @@index([type])
}

model Transaction {
  id                String           @id @default(uuid())
  code              String           @unique
  type              TransactionType
  date              DateTime         @default(now())
  amount            Decimal          @db.Decimal(15, 2)
  note              String?
  walletId          String
  walletToId        String?
  feeAmount         Decimal          @default(0) @db.Decimal(15, 2)
  incomeCategoryId  String?
  expenseCategoryId String?
  projectId         String?
  isCommonCost      Boolean          @default(false)
  supplierId        String?
  workshopId        String?
  workshopJobId     String?
  isSample          Boolean          @default(false)
  isAds             Boolean          @default(false)
  adsPlatform       String?
  createdByUserId   String?
  updatedByUserId   String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?
  expenseCategory   ExpenseCategory? @relation(fields: [expenseCategoryId], references: [id])
  incomeCategory    IncomeCategory?  @relation(fields: [incomeCategoryId], references: [id])
  project           Project?         @relation(fields: [projectId], references: [id])
  wallet            Wallet           @relation(fields: [walletId], references: [id], onDelete: Cascade)
  walletTo          Wallet?          @relation("WalletToRelation", fields: [walletToId], references: [id])
  workshopJob       WorkshopJob?     @relation(fields: [workshopJobId], references: [id])

  @@index([walletId])
  @@index([walletToId])
  @@index([type])
  @@index([date])
  @@index([incomeCategoryId])
  @@index([expenseCategoryId])
  @@index([projectId])
  @@index([isCommonCost])
  @@index([workshopJobId])
  @@index([deletedAt])
}

model WalletAdjustment {
  id              String    @id @default(uuid())
  walletId        String
  date            DateTime
  amount          Decimal   @db.Decimal(15, 2)
  note            String?
  createdByUserId String?
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  wallet          Wallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([date])
  @@index([deletedAt])
}

model Project {
  id              String                @id @default(uuid())
  code            String                @unique
  name            String
  customerId      String?
  workshopId      String?
  address         String?
  stage           String                @default("Lead")
  status          String                @default("PENDING")
  note            String?
  deadline        DateTime?
  discountAmount  Decimal?              @default(0) @db.Decimal(15, 2)
  isActive        Boolean               @default(true)
  isSample        Boolean               @default(false)
  deletedAt       DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  acceptanceItems OrderAcceptanceItem[]
  orderItems      OrderItem[]
  customer        Customer?             @relation(fields: [customerId], references: [id])
  workshop        Workshop?             @relation(fields: [workshopId], references: [id])
  transactions    Transaction[]
  workshopJobs    WorkshopJob[]

  @@index([customerId])
  @@index([workshopId])
  @@index([stage])
  @@index([deletedAt])
  @@index([deadline])
}

model OrderItem {
  id              String                @id @default(uuid())
  projectId       String
  productId       String?
  variantId       String?
  name            String
  unit            String
  qty             Decimal               @db.Decimal(15, 2)
  unitPrice       Decimal               @db.Decimal(15, 2)
  amount          Decimal               @db.Decimal(15, 2)
  note            String?
  isSample        Boolean               @default(false)
  createdByUserId String?
  updatedByUserId String?
  deletedAt       DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  acceptanceItems OrderAcceptanceItem[]
  product         Product?              @relation(fields: [productId], references: [id])
  project         Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  variant         ProductVariant?       @relation(fields: [variantId], references: [id])

  @@index([projectId])
  @@index([productId])
  @@index([variantId])
  @@index([deletedAt])
}

model OrderAcceptanceItem {
  id          String    @id @default(uuid())
  projectId   String
  orderItemId String
  acceptedQty Decimal   @default(0) @db.Decimal(15, 2)
  unitPrice   Decimal?  @db.Decimal(15, 2)
  note        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, orderItemId])
  @@index([projectId])
  @@index([orderItemId])
}

enum UserRole {
  ADMIN
  STAFF
}

enum CrmStage {
  LEAD
  QUOTED
  CONSIDERING
  APPOINTMENT_SCHEDULED
  CONTRACT_SIGNED
  CANCELLED
}

enum CrmActivityType {
  CALL
  MEETING
  MESSAGE
  NOTE
  QUOTE
  OTHER
}

enum FollowUpStatus {
  PENDING
  DONE
  MISSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum SourceChannel {
  FACEBOOK
  TIKTOK
  WEBSITE
  ZALO
  INTRODUCED
  REFERRAL
  WALK_IN
  OTHER
}

enum CustomerStatus {
  NEW
  CONTACTED
  CONSIDERING
  PRICE_TOO_HIGH
  APPOINTMENT_SET
  SURVEY_SCHEDULED
  WON
  LOST
}

enum FollowUpType {
  CALL
  MEETING
  SURVEY
  QUOTE
  OTHER
}

enum FollowUpOutcome {
  PENDING
  DONE
  CANCELLED
  NO_SHOW
}

enum WorkshopJobStatus {
  DRAFT
  SENT
  IN_PROGRESS
  DONE
  CANCELLED
}

enum WalletType {
  CASH
  BANK
  OTHER
}

enum VisualType {
  ICON
  IMAGE
}

enum ProductType {
  CEILING_WOOD
  FURNITURE
  OTHER_ITEM
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}
